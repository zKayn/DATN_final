// PRISMA WITH MONGODB - FIXED

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  email         String   @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  phone         String?
  avatar        String?
  status        String   @default("ACTIVE")
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  orders    Order[]
  reviews   Review[]
  cartItems CartItem[]
  wishlists Wishlist[]
  addresses Address[]

  @@map("users")
}

model Admin {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("SUPER_ADMIN")
  permissions  String[] @default([])
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admins")
}

model Product {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  slug          String   @unique
  description   String
  price         Float
  originalPrice Float?
  sku           String   @unique
  stock         Int      @default(0)
  categoryId    String   @db.ObjectId
  brandId       String   @db.ObjectId
  isActive      Boolean  @default(true)
  isFeatured    Boolean  @default(false)
  viewCount     Int      @default(0)
  soldCount     Int      @default(0)
  rating        Float?
  reviewCount   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category   Category         @relation(fields: [categoryId], references: [id])
  brand      Brand            @relation(fields: [brandId], references: [id])
  images     ProductImage[]
  variants   ProductVariant[]
  orderItems OrderItem[]
  reviews    Review[]
  cartItems  CartItem[]
  wishlists  Wishlist[]

  @@index([categoryId])
  @@index([brandId])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  productId String   @db.ObjectId
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model ProductVariant {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  productId String   @db.ObjectId
  size      String?
  color     String?
  stock     Int      @default(0)
  sku       String   @unique
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_variants")
}

model Category {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  slug        String   @unique
  description String?
  image       String?
  icon        String?
  parentId    String?  @db.ObjectId
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Brand {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  slug        String   @unique
  logo        String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("brands")
}

model Order {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber     String   @unique
  userId          String   @db.ObjectId
  total           Float
  subtotal        Float
  shippingFee     Float    @default(0)
  discount        Float    @default(0)
  status          String   @default("PENDING")
  paymentStatus   String   @default("PENDING")
  paymentMethod   String
  shippingMethod  String
  trackingNumber  String?
  shippingAddress Json
  notes           String?
  cancelReason    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user  User        @relation(fields: [userId], references: [id])
  items OrderItem[]

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String   @db.ObjectId
  productId String   @db.ObjectId
  quantity  Int
  size      String?
  color     String?
  price     Float
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Review {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  productId          String    @db.ObjectId
  userId             String    @db.ObjectId
  orderId            String?   @db.ObjectId
  rating             Int
  title              String?
  comment            String?
  images             String[]  @default([])
  isVerifiedPurchase Boolean   @default(false)
  isApproved         Boolean   @default(false)
  adminReply         String?
  adminReplyAt       DateTime?
  helpfulCount       Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  product      Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  helpfulVotes ReviewHelpfulVote[]

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([isApproved])
  @@map("reviews")
}

model ReviewHelpfulVote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  reviewId  String   @db.ObjectId
  userId    String   @db.ObjectId
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("review_helpful_votes")
}

model CartItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  productId String   @db.ObjectId
  quantity  Int
  size      String?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, size, color])
  @@index([userId])
  @@map("cart_items")
}

model Wishlist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  productId String   @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlists")
}

model Address {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  label     String
  fullName  String
  phone     String
  street    String
  ward      String?
  district  String
  city      String
  zipCode   String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model Coupon {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  code          String   @unique
  description   String?
  discountType  String
  discountValue Float
  minPurchase   Float?
  maxDiscount   Float?
  usageLimit    Int?
  usedCount     Int      @default(0)
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("coupons")
}
